<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Z-BLOG</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
  <link rel="icon" type="image/jpg" th:href="@{${basePath}+'stage/assets/i/favicon.jpg'}" href="stage/assets/i/favicon.jpg">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" th:href="@{${basePath}+'stage/assets/i/favicon.jpg'}" href="stage/assets/i/favicon.jpg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Amaze UI"/>
  <link rel="apple-touch-icon-precomposed" th:href="@{${basePath}+'stage/assets/i/favicon.jpg'}" href="stage/assets/i/favicon.jpg">
  <meta name="msapplication-TileImage" th:content="@{${basePath}+'stage/assets/i/favicon.jpg'}" content="stage/assets/i/favicon.jpg">
  <meta name="msapplication-TileColor" content="#0e90d2">
  <link rel="stylesheet" th:href="@{${basePath}+'stage/assets/css/amazeui.min.css'}" href="stage/assets/css/amazeui.min.css">
  <link rel="stylesheet" th:href="@{${basePath}+'stage/assets/css/app.css'}" href="stage/assets/css/app.css">
  <link rel="stylesheet" th:href="@{${basePath}+'plug-in/bootstrap3.3.7/fonts/glyphicons-halflings-regular.woff'}" href="plug-in/bootstrap3.3.7/fonts/glyphicons-halflings-regular.woff" />
  <link rel="stylesheet" th:href="@{${basePath}+'plug-in/bootstrap3.3.7/css/bootstrap.min.css'}" href="plug-in/bootstrap3.3.7/css/bootstrap.min.css" />
  <!-- <link rel="stylesheet" th:href="@{${basePath}+'/plug-in/bootstrap3.3.7/css/bootstrap-theme.min.css'}" href="plug-in/bootstrap3.3.7/css/bootstrap-theme.min.css" /> -->
  <link rel="stylesheet" th:href="@{${basePath}+'plug-in/editor.md-master/css/editormd.min.css'}" href="plug-in/editor.md-master/css/editormd.min.css" />
  <link rel="stylesheet" th:href="@{${basePath}+'plug-in/bootstrap3.3.7/buttons.css'}" href="plug-in/bootstrap3.3.7/buttons.css">
  <link rel="stylesheet" th:href="@{${basePath}+'moudle/admin.css'}" href="moudle/admin.css">
  <link rel="stylesheet" th:href="@{${basePath}+'moudle/spanstyle.css'}" href="moudle/spanstyle.css">
  <link th:href="@{${basePath}+'plug-in/fileinput/css/fileinput.css'}"  href="plug-in/fileinput/css/fileinput.css" media="all" rel="stylesheet" type="text/css" /> 
  
<style type="text/css">

</style>
</head>
<body id="blog" style="height: 100%; color: rgb(0, 0, 0); ">
<!-- <header class="am-g am-g-fixed blog-fixed blog-text-center blog-header">
	
    <div class="am-u-sm-8 am-u-sm-centered">
        <img width="200" src="https://www.aroad.xyz/source/img/favicon.png" alt="Amaze UI Logo"/>
        <h2 class="am-hide-sm-only">我似江潮来又去，君如鸥鹭逐波还</h2>
    </div>
</header>
<hr> -->
<!-- <div th:include="common/admin :: daoTop"></div> -->
<!--  <p th:text="'Hello！, ' + ${#servletContext.contextPath} + '!'">3333</p> -->
<div class="container">
	<div class="row">
		<label class="col-sm-12 "><span>写博客</span> <!-- >> <a href="blist">博客列表</a>  <span th:text="${basePath}"></span> --></label>
			<!-- enctype="multipart/form-data" -->
			<form id="formObj" class="form-horizontal" role="form" method="post" action="saveblog">
			<textarea id="blog_md" name="articleTabloid" value="" style="display: none;"></textarea>
    		<textarea id="blog_html" name="articleContent" value="" style="display: none;"></textarea>
				<div class="form-group input-group-sm" >
					<label for="" class="col-sm-1 control-label"></label>
					<div class="col-sm-10" height="20px">
						<!-- <button type="button" onclick="saveBlog(0)"  class="btn btn-success" data-dismiss="modal">保存博客</button>   -->
						<button type="button" onclick="saveBlog(1)" class="btn button-primary " >发表博客</button> 
					</div>
				</div>
				<div class="form-group input-group-sm">
					<label for="articleTitle" class="col-sm-1 control-label">文章标题</label>
					<div class="col-sm-11">
						<input type="text" class="form-control" id="articleTitle" name="articleTitle"  placeholder="请输入文章标题">
					</div>
				</div>
				<div class="form-group">
					<label for="articleAuthor" class="col-sm-1 control-label">文章作者</label>
					<div class="col-sm-5">
						<input type="text" class="form-control" id="articleAuthor" name="articleAuthor" value="文章作者111" placeholder="请输入文章作者" >
					</div>
					<label for="input_type_id" class="col-sm-1 control-label">文章类型</label>
					<div class="col-sm-4">
						<!-- <input type="text" class="form-control" id="articleType" value="文章类型111" placeholder="请选择文章类型"> -->
						<!-- 文章类型ID -->
					    <select class="form-control" name="articleType" id="input_type_id">
					    	<option value="">请选择文章类型</option>
						</select>
				     	<span id="web_id_block" class="help-block"></span>
					</div>
				</div>
				<div class="form-group">
					<label for="articleContent" class="col-sm-1 control-label">文章内容</label>
					<div class="col-sm-11" align="left">
						<div id="editormd">
							<textarea style="display: none;" id="articleContent"></textarea>
							<!--     <textarea class="editormd-markdown-textarea" name="markdown-area" style="display:none;"># 请输入标题</textarea>
			        <textarea class="editormd-html-textarea" name="html-area"></textarea> -->
						</div>
					</div>
				</div>
				<div class="form-group">
					<label for="articleTabloid" class="col-sm-1 control-label">文章摘要</label>
					<div class="col-sm-10">
						<textarea rows="4" cols="150" id="articleTabloid" value="" placeholder="请输入文章摘要"> </textarea>
					</div>
				</div>
				<div class="form-group">
					<label for="articleTags" class="col-sm-1 control-label">文章标签</label>
					<div class="col-sm-11">
						<input type="hidden" id="tagIds" name="tagAIds" value=""/>
						<!-- <input type="text" class="form-control" id="articleTags" value="文章标签1112" placeholder="请选择标签"> -->
						<div id="articleTags" class="textarea" contenteditable="false" placeholder="请选择标签"></div>
					</div>
				</div>
				<div class="form-group">
					<label for="lastname" class="col-sm-1 control-label">可选标签</label>
					<div class="col-sm-11" id="tagAll">
						
						<!-- <textarea rows="4" cols="100"> </textarea> -->
					</div>
				</div>
				<div class="form-group">
				    <label for="imgUrl" class="col-sm-1 control-label">文章封面</label>
				    <div class="col-sm-10">
				    	<input type="" id="imgUrl" name="" value="">
				    	<input type="" id="articleImage" name="articleImage" value="">
		                   <input name="img" id="img" type="file" class="file" data-show-upload="false" data-show-preview="true">
				    </div>
			  	</div>
		</form>
	</div>
</div>
<hr>
<footer class="blog-footer">
    <!--  <div th:include="common/footer :: copy"></div> -->
    <!-- <div class="blog-text-center">© 2015 AllMobilize, Inc. Licensed under MIT license. Made with love By LWXYFER</div>     -->
  </footer>

<!-- <script th:src="@{{path}/plug-in/jquery/jquery-1.9.1.min.js(path=${#servletContext.contextPath})}" src="plug-in/jquery/jquery-1.9.1.min.js"></script>
 -->
<script th:src="@{${basePath}+'plug-in/fileinput/js/jquery-2.0.3.min.js'}" src="plug-in/fileinput/js/jquery-2.0.3.min.js"></script> 
<script th:src="@{${basePath}+'plug-in/editor.md-master/editormd.min.js'}" src="plug-in/editor.md-master/editormd.min.js"></script>
<script th:src="@{${basePath}+'stage/assets/js/amazeui.min.js'}"></script> 
<script th:src="@{${basePath}+'plug-in/bootstrap3.3.7/js/bootstrap.min.js'}" src="plug-in/bootstrap3.3.7/js/bootstrap.min.js" type="text/javascript"></script> 
<script th:src="@{${basePath}+'moudle/js/form.js'}" src="moudle/js/form.js" type="text/javascript"></script>
<script th:src="@{${basePath}+'plug-in/fileinput/js/fileinput.js'}" src="plug-in/fileinput/js/fileinput.js" type="text/javascript"></script>
<script th:src="@{${basePath}+'plug-in/fileinput/js/fileinput_locale_zh.js'}" src="plug-in/fileinput/js/fileinput_locale_zh.js" type="text/javascript"></script>  
<script type="text/javascript">
	var editor;

    $(function() {
        editor = editormd("editormd", {
        	placeholder : ' 欢迎使用博客',
        	htmlDecode : "style,script,iframe",
        	width: "100%",
            height: 350,
            syncScrolling: "single",
            imageUpload : true,
            imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],  
            imageUploadURL : "uploadfile",  
            saveHTMLToTextarea : true,
            path : "plug-in/editor.md-master/lib/",
            emoji: true// Autoload modules mode, codemirror, marked... dependents libs path
            
            
        });
        
        //var oFileInput = fileinputInit;
       // oFileInput.Init("img", "'upload/img'");
    });
    
    function saveBlog(t){
    
    	var formData = $("#formObj").serializeObject();
    	//var formData = getFormData("#formObj");
    	console.log(formData);
    	var articleContent = editor.getHTML();
    	var articleContentMd = editor.getMarkdown();
    	var articleType = $("#input_type_id option:selected").val();
    	var articleTabloid = $("#articleTabloid").val();
    	var tagIds = $("#tagIds").val();
    	//formData.append("articleContent",articleContent);
    	//var file = $('#file-4').get(0).files[0];
    	//formData.append("file",file);
    	//var all = [{ 'isDraft' : t ,'articleContent' : articleContent, 'articleContentMd' :articleContentMd,'articleType' : articleType,'tagIds':tagIds}];
    	formData.articleContent = articleContent;
    	formData.articleContentMd=articleContentMd;
    	formData.articleType=articleType;
    	formData.articleTabloid=articleTabloid;
    	formData.tagIds=tagIds;
    	formData.isDraft=t;
    	var params = formData;
    	console.log(params);
    	$.ajax({
			url:'saveblog',
			type:'post',
			datatype: 'json',
			data:JSON.stringify( params ),
			async: false,  
			cache: false, 
			contentType:'application/json;charset=utf-8',
			//contentType: false, //不设置内容类型
			//processData: false, //不处理数据
			success:function(data){
				console.log(data);
				var status = data.success;
				if(status){
					$('#delcfmModel').modal(); 
					
				}
				alert(data.msg);
			},
			error:function(responseText,status,error){
				console.log(status);
				console.log(responseText);
				console.log(error);
				alert("失败！");
			}
		})
    }
    function urlSubmit(){
    	window.location.href='bglist';
    }
    
    function getArticleTypes(){
		$.ajax({
			url:"typeList",
			data:JSON.stringify({}),
			type:"post",
			contentType: "application/json;charset=UTF-8",
			success:function(result){
				//console.log(result);
				
				$("#input_type_id").empty();
				$("#input_type_id").append($("<option value=\"\">请选择文章类型</option>)"));
				$.each(result.extend.list,function(){

					var optionEl = $("<option ></option>").append(this.typeName+" - ").attr("value",this.id);
					$("#input_type_id").append(optionEl);
				});
				 //$("#input_type_id option[value="+typeId+"]").attr("selected", true); 
			},
			error:function(responseText,status,error){
				console.log(status);
				console.log(responseText);
				console.log(error);
				alert("失败！");
			}
		});
	}
    function setTagAll(){
    	$.ajax({
			url:"tagList",
			data:JSON.stringify({}),
			type:"post",
			contentType: "application/json;charset=UTF-8",
			success:function(result){
				//console.log(result);
				$("#tagAll").empty();
				$.each(result.extend.list,function(i,val){
					if(i>9){i = i%9;}
					var optionEl = $("<span class='spanstyle"+i+" '></span>").append(this.tagName+"  ").attr("value",this.id);
					$("#tagAll").append(optionEl);
				});
			},
			error:function(responseText,status,error){
				console.log(status);
				console.log(responseText);
				console.log(error);
				alert("失败！");
			}
		});
    }
    $(function(){
    	getArticleTypes();
    	setTagAll();
    });
    
    $("#tagAll").on("click","span",function(){
		var htl = $(this).prop('outerHTML');
		console.log(htl);
		var tid = $(htl).attr('value');
		var tags = $.trim($("#articleTags").html());
		console.log(tags.indexOf(htl));
		if(tags!="" && tags.indexOf(htl) != -1){
			//已经存在
		}else{
			var allids = $("#tagIds").val();

			allids += tid +",";
	    	
			$("#tagIds").val(allids);
			$("#articleTags").append(htl);
		}
		
	});
	
	$("#articleTags").on("click","span",function(){
		var span = $(this).prop('outerHTML');
		var tid = $(span).attr('value')+",";
		
		var allids = $("#tagIds").val();
		var newIds = allids.replace(tid,'');
		$("#tagIds").val(newIds);
		//$("#articleTags").append(htl);
		$(this).remove();
	});
	
	$("#img").fileinput({
	      uploadUrl:"upload/img", //接受请求地址
	      uploadAsync : true, //默认异步上传
	      showUpload : false, //是否显示上传按钮,跟随文本框的那个
	      showRemove : true, //显示移除按钮,跟随文本框的那个
	      showCaption : true,//是否显示标题,就是那个文本框
	      showPreview : true, //是否显示预览,不写默认为true
	      dropZoneEnabled : true,//是否显示拖拽区域，默认不写为true，但是会占用很大区域
	      //minImageWidth: 50, //图片的最小宽度
	      //minImageHeight: 50,//图片的最小高度
	      //maxImageWidth: 1000,//图片的最大宽度
	      //maxImageHeight: 1000,//图片的最大高度
	      //maxFileSize: 0,//单位为kb，如果为0表示不限制文件大小
	      //minFileCount: 0,
	      'theme': 'explorer',
	      maxFileCount : 1, //表示允许同时上传的最大文件个数
	      enctype : 'multipart/form-data',
	      validateInitialCount : true,
	      previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
	      msgFilesTooMany : "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
	      allowedFileTypes : [ 'image' ],//配置允许文件上传的类型
	      //allowedPreviewTypes : [ 'image' ],//配置所有的被预览文件类型
	      //allowedPreviewMimeTypes : [ 'jpg', 'png', 'gif' ],//控制被预览的所有mime类型
          textEncoding : "UTF-8",//文本编码
          //overwriteInitial: false,
	      language : 'zh',
	      uploadExtraData:function (previewId, index) { 
	    	    console.log(index+" , previewId = " +previewId);//传参
          	    var data = {
                      "picType": 1,      //此处自定义传参
                  };
                  return data;
          }
	  })
	  //异步上传返回结果处理
	  $('#img').on('fileerror', function(event, data, msg) {
	      console.log("fileerror");
	      console.log(data);
	  });
	  //异步上传返回结果处理
	  $("#img").on("fileuploaded", function(event, data, previewId, index) {
		  var imageUrl = data.response.imgUrl;
		  var imageId = data.response.imageId;
	      console.log(imageUrl);
		  $("#imgUrl").val(imageUrl);
		  $("#articleImage").val(imageId);
	      var ref = $(this).attr("data-ref");
	      $("input[name='" + ref + "']").val(data.response.imageUrl);

	  });

	  //上传前
	  $('#img').on('filepreupload', function(event, data, previewId, index) {
	      console.log("filepreupload");
	  });
 
</script>
<!-- 信息删除确认 -->  
<div class="modal fade" id="delcfmModel">  
  <div class="modal-dialog">  
    <div class="modal-content message_align">  
      <div class="modal-header">  
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>  
        <h4 class="modal-title">提示信息</h4>  
      </div>  
      <div class="modal-body">  
        <p>您是否要前往博文列表页面？</p>  
        <p>确定则前往列表页，取消则留着当前页。</p>  
      </div>  
      <div class="modal-footer">  
         <input type="hidden" id="url"/>  
         <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>  
         <button type="button" onclick="urlSubmit()"  class="btn btn-success" data-dismiss="modal">确定</button>  
      </div>  
    </div><!-- /.modal-content -->  
  </div><!-- /.modal-dialog -->  
</div><!-- /.modal -->  
</body>
</html>
